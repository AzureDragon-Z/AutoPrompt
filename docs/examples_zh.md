# 提示优化示例

本文档提供了在各种场景下使用 AutoPrompt 流水线的实用示例。重点展示电影评论和聊天审核任务，以演示 AutoPrompt 框架的灵活性和有效性。

1.  [过滤含剧透的电影评论（分类任务）](#过滤含剧透的电影评论分类任务)
2.  [电影类型识别（多标签分类任务）](#电影类型识别多标签分类任务)
3.  [为电影评论评分（评分任务）](#为电影评论评分数任务)
4.  [生成电影评论（生成任务）](#生成电影评论生成任务)
5.  [单一主题审核](#单一主题审核)
6.  [多主题审核（提示压缩任务）](#多主题审核提示压缩任务)

### 过滤含剧透的电影评论（分类任务）

在这个二分类示例中，我们的目标是过滤掉包含特定电影剧透的评论。一个正确实现的过滤器可以成为大规模影评系统中的强大工具。

我们将从一个简单的初始提示和任务描述开始：
-   初始提示："这部电影评论是否包含剧透？回答是或否"
-   任务描述："助手是一个专家分类器，负责对电影评论进行分类，并告知用户该评论是否包含所评论电影的剧透。"

#### 运行示例步骤

1.  通过编辑 `config/config_default.yml` 来配置你的标签。修改 `dataset` 部分中的 `label_schema`，使其仅包含 '是' 和 '否' 选项。

    ```yaml
    dataset:
        name: 'dataset'
        records_path: null
        initial_dataset: 'dump/dataset.csv'
        label_schema: ["是", "否"]
        max_samples: 50
    ```

2.  从 IDE 或命令行运行主流水线。
    ```bash
    > python run_pipeline.py
    ```
    *注意*：如果没有输入参数，流水线会提示用户提供。或者，可以将初始提示和任务描述指定为命令行参数：
    ```bash
    > python run_pipeline.py \
        --prompt "这部电影评论是否包含剧透？回答是或否" \
        --task_description "助手是一个专家分类器，负责对电影评论进行分类，并告知用户该评论是否包含所评论电影的剧透。"
    ```

3.  一个显示 Argilla 工作空间的浏览器窗口将打开，用于手动标注。
    ![argilla示例](./argilla_movie_spoilers_example.png)

    标注生成的示例，并监控流水线的进度。使用 `num_steps` 参数控制优化迭代次数，在启动时指定：
    ```bash
    > python run_pipeline.py --num_steps 30
    ```
    流水线在达到 `num_steps` 或满足 `config/config_default.yml` 中定义的预定义停止条件后结束：
    ```yaml
    stop_criteria:
        max_usage: 0.5  # 优化最大预算（对于 OpenAI 的 LLM 模型为美元）
        patience: 3     # 等待改进的迭代次数
        min_delta: 0.05 # 迭代间的最小改进量
    ```
    请注意，该框架也支持使用 LLM 作为标注器，设置说明参见[此处](installation.md#configure-llm-annotator)。

4.  完成后，流水线会输出一个为该任务量身定制的**优化后的提示** 和一个包含挑战性样本的参考**基准**。在此示例中，最终的剧透识别提示可能是：

    ```
    评论剧透识别协议：对于对 IMDB 评论进行剧透存在性分类的任务，分类器必须对包含细微语言和间接剧透线索的评论保持高度敏感。分类标签为“是”（表示有剧透）和“否”（表示无剧透）。请严格应用以下标准：如果评论符合以下情况，则标记为“是”：- 包含对剧情发展或角色弧光的微妙提及或细微语言暗示，即使没有明确细节。- 包含间接揭示剧情结果或转折的情感反应或描述性语言。- 使用指向未来事件或结局的暗示性语言，即使未透露具体信息。如果评论符合以下情况，则标记为“否”：- 以不暗示或透露任何剧情细节的方式讨论技术方面、表演、导演或个人观看印象。- 评论主题元素、类型特征或叙事技巧，但未披露或暗示关键剧情转折。
    ```

    -   该框架会自动将基准、运行日志和检查点文件（存储优化状态，支持从上次运行处无缝继续）保存在默认的 `dump` 路径中，可通过 `--output_dump` 命令行参数调整。
    -   请注意，上述步骤与所有分类和生成任务相关。更多用例请参见以下示例。

5.  到目前为止，我们仅使用初始提示和任务描述启动了流水线。但是，你也可以通过指定初始数据集来包含一些示例，即在 `config/config_default.yml` 文件的 `dataset` 部分的 `initial_dataset` 字段中指定。例如：
    ```yaml
    dataset:
        initial_dataset: 'dump/dataset.csv'
    ```
    包含两个样本的初始数据集示例如下：
    ```
    id,text,prediction,annotation,metadata,score,batch_id
    0,"电影摄影令人着迷，尤其是在他们最终揭示吸引主角的神秘房间的场景中。",否,是,,,0
    1,"导演大胆地选择将世界的命运留到最后一帧才揭晓，这将引发观众的讨论。",否,是,,,0
    ```

### 电影类型识别（多标签分类）：

在这个例子中，我们希望将电影评论分割成预定义的类型。初始提示和任务描述可能如下所示：
-   初始提示："根据以下电影评论，这部电影是什么类型？在动作、喜剧、剧情、爱情或恐怖中选择。"
-   任务描述："助手是一位精通所有类型的专业影评人，负责对其他电影评论进行分类。"

#### 运行示例

对于这个多标签分类，更新 `config/config_default.yml` 中的 `label_schema`
```yaml
dataset:
    label_schema: ["动作", "喜剧", "剧情", "爱情", "恐怖"]